# ASP.NET Core 9 - Build & Publish
# Para cuentas gratis de App Service usar --runtime win-x86

trigger:
  branches:
    include:
      - main
      - master

pool:
  vmImage: 'windows-latest'

variables:
  buildConfiguration: 'Release'
  proyecto: 'PracticaFinalAPI/PracticaFinalAPI.csproj'

steps:
  - task: UseDotNet@2
    displayName: 'Instalar .NET SDK 9'
    inputs:
      packageType: 'sdk'
      # Usa siempre la última 9.0.x disponible en el agente
      version: '9.0.x'
      includePreviewVersions: false

  - script: dotnet --info
    displayName: 'Información de .NET'

  - script: dotnet restore PracticaFinalCI_CD.sln
    displayName: 'dotnet restore'

  - script: dotnet build PracticaFinalCI_CD.sln --configuration $(buildConfiguration) --no-restore
    displayName: 'dotnet build $(buildConfiguration)'

  - script: dotnet test PracticaFinalAPI.Tests/PracticaFinalAPI.Tests.csproj --configuration $(buildConfiguration) --no-build --verbosity normal
    displayName: 'Ejecutar Pruebas Unitarias'
    continueOnError: true

  - task: DotNetCoreCLI@2
    displayName: 'Publicar aplicación'
    inputs:
      command: 'publish'
      publishWebProjects: false
      projects: '$(proyecto)'
      arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory) --runtime win-x86 --self-contained true'
      zipAfterPublish: true
      modifyOutputPath: false

  - task: PublishBuildArtifacts@1
    displayName: 'Publicar artefactos'
    inputs:
      pathToPublish: '$(Build.ArtifactStagingDirectory)'
      artifactName: 'drop'
      publishLocation: 'Container'

  # Stage de Despliegue (CD) - Descomenta cuando configures la Service Connection de Azure
  # Para configurar:
  # 1. Ve a Project Settings > Service connections en Azure DevOps
  # 2. Crea una conexión de tipo "Azure Resource Manager"
  # 3. Reemplaza 'Azure-ServiceConnection' y 'practica-final-api' con tus valores reales
  #
  # - task: DownloadBuildArtifacts@0
  #   displayName: 'Descargar Artefactos'
  #   inputs:
  #     buildType: 'current'
  #     downloadType: 'single'
  #     artifactName: 'drop'
  #     downloadPath: '$(System.ArtifactsDirectory)'
  #
  # - task: AzureWebApp@1
  #   displayName: 'Desplegar a Azure App Service'
  #   inputs:
  #     azureSubscription: 'Azure-ServiceConnection'
  #     appName: 'practica-final-api'
  #     package: '$(System.ArtifactsDirectory)/drop/**/*.zip'
  #     deploymentMethod: 'auto'
